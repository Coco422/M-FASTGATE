{% extends "base.html" %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="/admin/ui/">管理面板</a></li>
<li class="breadcrumb-item active">统计信息</li>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1><i class="fas fa-chart-bar me-2"></i>统计信息</h1>
                <p class="text-muted">查看API网关使用统计和性能分析</p>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-success" onclick="refreshStats()">
                    <i class="fas fa-sync-alt me-2"></i>刷新数据
                </button>
                <button class="btn btn-outline-primary" onclick="exportReport()">
                    <i class="fas fa-download me-2"></i>导出报告
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 时间范围选择 -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="row g-3 align-items-end">
                    <div class="col-md-3">
                        <label class="form-label">统计时间范围</label>
                        <select class="form-select" id="timeRange">
                            <option value="24h">最近24小时</option>
                            <option value="7d">最近7天</option>
                            <option value="30d" selected>最近30天</option>
                            <option value="90d">最近90天</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">API Key 筛选</label>
                        <select class="form-select" id="apiKeyFilter">
                            <option value="">全部API Key</option>
                            <!-- 选项通过JavaScript动态加载 -->
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">分组方式</label>
                        <select class="form-select" id="groupBy">
                            <option value="hour">按小时</option>
                            <option value="day" selected>按天</option>
                            <option value="week">按周</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-primary w-100" onclick="applyFilters()">
                            <i class="fas fa-search me-2"></i>应用筛选
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 总体统计卡片 -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-gradient-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 id="totalRequests">-</h4>
                        <p class="mb-0">总请求数</p>
                        <small class="opacity-75">
                            <span id="requestsTrend">-</span> vs 上期
                        </small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-exchange-alt fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-gradient-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 id="successRate">-</h4>
                        <p class="mb-0">成功率</p>
                        <small class="opacity-75">
                            <span id="successTrend">-</span> vs 上期
                        </small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-check-circle fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-gradient-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 id="avgResponseTime">-</h4>
                        <p class="mb-0">平均响应时间</p>
                        <small class="opacity-75">
                            <span id="responseTrend">-</span> vs 上期
                        </small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-clock fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-gradient-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 id="activeKeys">-</h4>
                        <p class="mb-0">活跃API Key</p>
                        <small class="opacity-75">
                            <span id="keysTrend">-</span> vs 上期
                        </small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-key fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 图表区域 -->
<div class="row mb-4">
    <!-- 请求趋势图 -->
    <div class="col-md-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-chart-line me-2"></i>请求趋势分析
                </h5>
                <div class="btn-group btn-group-sm" role="group">
                    <input type="radio" class="btn-check" name="chartType" id="requestsChart" checked>
                    <label class="btn btn-outline-primary" for="requestsChart">请求量</label>
                    
                    <input type="radio" class="btn-check" name="chartType" id="responseChart">
                    <label class="btn btn-outline-primary" for="responseChart">响应时间</label>
                    
                    <input type="radio" class="btn-check" name="chartType" id="errorsChart">
                    <label class="btn btn-outline-primary" for="errorsChart">错误率</label>
                </div>
            </div>
            <div class="card-body">
                <canvas id="trendsChart" height="100"></canvas>
            </div>
        </div>
    </div>
    
    <!-- API Key 使用分布 -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-pie me-2"></i>API Key 使用分布
                </h5>
            </div>
            <div class="card-body">
                <canvas id="usageChart" height="150"></canvas>
                <div class="mt-3" id="usageStats">
                    <!-- 使用统计将通过JavaScript填充 -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- API Key 排行榜和错误分析 -->
<div class="row mb-4">
    <!-- API Key 排行榜 -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-trophy me-2"></i>API Key 使用排行
                </h5>
                <select class="form-select w-auto" id="rankingMetric">
                    <option value="requests">按请求数</option>
                    <option value="data_transfer">按数据传输</option>
                    <option value="response_time">按响应时间</option>
                </select>
            </div>
            <div class="card-body">
                <div id="keyRanking">
                    <!-- 排行榜将通过JavaScript填充 -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- 错误分析 -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>错误状态码分析
                </h5>
            </div>
            <div class="card-body">
                <canvas id="errorsBreakdownChart" height="120"></canvas>
                <div class="mt-3">
                    <div id="errorsList">
                        <!-- 错误列表将通过JavaScript填充 -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 详细统计表格 -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-table me-2"></i>详细统计数据
                </h5>
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-info" onclick="exportTableData()">
                        <i class="fas fa-download me-1"></i>导出表格
                    </button>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" 
                                data-bs-toggle="dropdown">
                            <span id="tablePageSize">20</span> 条/页
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" onclick="changeTablePageSize(10)">10</a></li>
                            <li><a class="dropdown-item" onclick="changeTablePageSize(20)">20</a></li>
                            <li><a class="dropdown-item" onclick="changeTablePageSize(50)">50</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover table-sm">
                        <thead class="table-light">
                            <tr>
                                <th>API Key</th>
                                <th>用户</th>
                                <th>请求总数</th>
                                <th>成功请求</th>
                                <th>失败请求</th>
                                <th>成功率</th>
                                <th>平均响应时间</th>
                                <th>数据传输</th>
                                <th>最后使用</th>
                            </tr>
                        </thead>
                        <tbody id="statsTable">
                            <tr>
                                <td colspan="9" class="text-center text-muted">
                                    <i class="fas fa-spinner fa-spin me-2"></i>
                                    加载中...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 分页 -->
<div class="row mt-3">
    <div class="col-12">
        <nav aria-label="统计表格分页">
            <ul class="pagination justify-content-center" id="tablePagination">
                <!-- 分页按钮将通过JavaScript生成 -->
            </ul>
        </nav>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{{ api_base }}/ui/static/js/statistics.js"></script>
{% endblock %} 