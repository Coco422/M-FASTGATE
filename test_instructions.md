# M-FastGate Phase 1 测试指南

## 测试脚本说明

`test_phase1.py` 是一个完整的交互式测试脚本，用于验证 M-FastGate 的 Phase 1 功能。

## 测试功能覆盖

### 1. 基础框架功能
- ✅ 健康检查接口 (`/health`)
- ✅ 根路径接口 (`/`)
- ✅ API文档接口 (`/docs`)

### 2. API Key 管理功能
- ✅ 创建 API Key
- ✅ 查询 API Key 列表
- ✅ 查询单个 API Key 详情
- ✅ 更新 API Key
- ✅ 删除 API Key（清理阶段）

### 3. 路由代理功能
- ✅ GET 请求代理转发
- ✅ POST 请求代理转发
- ✅ X-API-Key 认证方式
- ✅ Authorization Bearer 认证方式
- ✅ 未认证请求拦截
- ✅ 无效路径处理

### 4. 审计日志功能
- ✅ 查询审计日志列表
- ✅ 按 API Key 过滤日志
- ✅ 日志内容验证

### 5. 统计指标功能
- ✅ 获取整体统计指标
- ✅ 获取路由配置信息

## 使用方法

### 前提条件

1. 确保 M-FastGate 服务已启动：
```bash
python -m app.main
```

2. 安装测试依赖：
```bash
pip install requests
```

### 运行测试

```bash
python test_phase1.py
```

### 测试模式

#### 1. 交互式测试（推荐）
- 可以选择单独测试某个功能
- 逐步验证各个模块
- 适合开发调试

#### 2. 完整测试
- 一次性运行所有测试
- 自动清理测试数据
- 适合CI/CD或完整验证

## 测试特性

### 自动化功能
- ✅ 自动检测服务端口（8000或8514）
- ✅ 自动启动模拟目标服务器
- ✅ 自动清理测试数据
- ✅ 详细的测试结果输出

### 智能验证
- ✅ HTTP状态码验证
- ✅ 响应数据结构验证
- ✅ API Key生命周期管理
- ✅ 错误场景测试

### 模拟环境
- ✅ 内置HTTP模拟服务器（端口8001）
- ✅ 支持GET/POST请求模拟
- ✅ JSON响应格式模拟

## 测试输出示例

```
🧪 M-FastGate Phase 1 交互式测试
============================================================
1. 测试基础框架功能
2. 测试API Key管理
3. 测试路由代理功能
4. 测试审计日志功能
5. 测试统计指标功能
6. 运行完整测试
7. 清理测试数据
0. 退出

============================================================
  测试 1: 基础框架功能
============================================================

📋 1.1 测试健康检查接口
----------------------------------------
✅ 健康检查成功
   📄 响应数据: {
     "status": "healthy",
     "timestamp": "2025-06-04T10:27:20.015211",
     "version": "0.0.1",
     "name": "M-FastGate"
   }
```

## 故障排除

### 常见问题

1. **连接错误**
   - 确认 M-FastGate 服务已启动
   - 检查端口是否正确（8000或8514）

2. **权限错误**
   - 确认管理员令牌正确（`admin_secret_token_dev`）
   - 检查配置文件是否正确加载

3. **代理测试失败**
   - 脚本会自动启动模拟服务器
   - 如果端口8001被占用，请释放该端口

4. **数据库错误**
   - 确认数据库文件有写入权限
   - 检查SQLite数据库是否正常创建

### 配置调整

如需修改测试配置，编辑 `test_phase1.py` 中的 `TestConfig` 类：

```python
class TestConfig:
    BASE_URL = "http://localhost:8514"  # 修改为实际端口
    ADMIN_TOKEN = "admin_secret_token_dev"  # 修改为实际令牌
    MOCK_SERVER_PORT = 8001  # 修改模拟服务器端口
```

## 测试报告

脚本会输出详细的测试结果，包括：
- ✅ 成功的测试项目
- ❌ 失败的测试项目
- 📄 详细的响应数据
- ⏰ 测试时间戳

## 下一步

完成 Phase 1 测试后，可以：
1. 查看生成的审计日志
2. 检查数据库中的数据
3. 准备 Phase 2 功能开发
4. 部署到生产环境 