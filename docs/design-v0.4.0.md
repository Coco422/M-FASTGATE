# M-FastGate v0.4.0 设计文档

## 1. 版本概述

v0.4.0 版本旨在进一步提升系统的可用性和可观测性。本次更新包含两大核心任务：
1.  **完成API请求方式的统一**：确保所有 API 请求方式仅使用 `GET` 或 `POST`，以兼容更多受限的网络环境。
2.  **完善审计日志模块**：对审计日志模块进行功能增强和体验优化，补齐前后端功能，使其更具实用性。

## 2. API 请求方式统一

延续 v0.3.0 版本的目标，我们继续审查并确保系统中所有的 API 请求都遵循仅使用 `GET` 和 `POST` 方法的原则。

- **任务状态**: 已完成。
- **变更说明**: 经过审查，v0.3.0 的更新已覆盖了所有 `PUT` 和 `DELETE` 请求的改造。v0.4.0 中所有新增的后端接口也遵循了此约定。

## 3. 审计日志模块完善

此前的审计日志模块功能较为初级，信息展示不清晰，且缺乏有效的分析工具。本次升级围绕以下几个方面进行了完善。

### 3.1. 核心需求

- **信息对齐与展示优化**: 解决前后端信息不一致的问题，特别是关联信息的展示。简化主列表视图，突出核心信息，将次要信息移至详情页。
- **提升可用性**: 优化用户交互，提供更强大、直观的日志筛选和统计功能。

### 3.2. 功能点详情

#### 3.2.1. 主列表视图优化与 Key 来源显示

- **问题**:
    1.  对于使用 API Key 的调用，无法直观看到该 Key 的归属或来源。
    2.  日志列表展示了过多信息，核心数据不突出。
- **目标与实现**:
    - **后端**: 在返回审计日志列表的 API (`/admin/logs`) 中，通过 `LEFT JOIN` 关联 `api_keys` 表，并附带上 `source_path` (API Key 的来源路径) 字段。
    - **前端**:
        - 在审计日志表格中增加 “Key 来源” 列，展示该 `source_path` 字段。
        - 简化主列表，仅保留 **时间、Key 来源、方法、路径、状态、耗时** 和操作按钮。其余详细信息（如IP、User-Agent、请求/响应体等）保留在点击“查看详情”弹窗中。

#### 3.2.2. 完善筛选功能

- **问题**: 日志筛选功能不够便捷，无法快速定位问题。
- **目标与实现**:
    - **前端**:
        - 将 **"Key 来源"** 的筛选器从文本输入框改为 **下拉选择框**。该下拉框在页面加载时，通过新接口动态获取并展示所有唯一的 `source_path`。
        - "状态码"筛选器改为文本输入框，支持输入具体状态码（如 `200`, `404`）进行过滤。
        - 保留并优化了按 API Key (模糊搜索)、请求方法 (下拉框)、来源路径和时间范围的筛选功能。
    - **后端**:
        - 新增 `/admin/keys/sources` 接口，用于返回去重后的 `source_path` 列表，以填充前端下拉框。
        - 改造查询审计日志的 API (`/admin/logs`)，使其支持按 `source_path` (作为"调用者"进行筛选) 进行过滤。

#### 3.2.3. 完善统计功能

- **问题**: 缺乏对日志数据的宏观统计，不利于分析系统整体状态。
- **目标与实现**:
    - **后端**:
        - **增强现有的 `/admin/metrics` 接口**，而非新增接口。
        - 在原有统计基础上，新增了 **TOP 5 调用最频繁的 Key 来源 (`source_path`)** 的聚合查询。
    - **前端**:
        - 在审计日志页面新增了 "更多统计" 区域。
        - 使用卡片式列表分别展示 **Top 5 访问路径** 和 **Top 5 Key 来源** 的统计数据。

## 4. 总结

v0.4.0 版本的核心是让 M-FastGate 在满足兼容性的基础上，变得更加 "好用" 和 "可控"。通过对审计日志这一关键功能进行深度优化，希望能显著提升管理员对网关状态的洞察能力，快速定位问题，并为未来的系统优化提供数据支持。 